# Eventarc Trigger Composition
apiVersion: composition.google.com/v1alpha1
kind: Composition
metadata:
  name: eventarc-trigger-composition
  namespace: config-control # Added namespace
spec:
  inputAPIGroup: creventarctriggers.idp.mycompany.com
  expanders:
  - type: jinja2
    name: eventarc-trigger
    template: |
      apiVersion: eventarc.cnrm.cloud.google.com/v1beta1
      kind: EventarcTrigger
      metadata:
        name: {{ creventarctriggers.spec.triggerName }}
        namespace: config-control
      spec:
        destination:
          workflowRef:
            external: {{ creventarctriggers.spec.workflowPath }}
        location: {{ creventarctriggers.spec.location }}
        serviceAccountRef:
          name: {{ creventarctriggers.spec.serviceAccount }}
        transport:
          pubsub:
            topicRef:
              name: {{ creventarctriggers.spec.topicName }}
              namespace: config-control
        matchingCriteria:
        - attribute: "type"
          value: "google.cloud.pubsub.topic.v1.messagePublished"
        projectRef:
          external: "projects/test-gcp-tse"
## change value
---
# Eventarc Trigger CRD
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: creventarctriggers.idp.mycompany.com
spec:
  group: idp.mycompany.com
  names:
    kind: CREventarcTrigger
    plural: creventarctriggers
    singular: creventarctrigger
  scope: Namespaced
  versions:
  - name: v1
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              triggerName:
                type: string
              workflowPath:
                type: string
              location:
                type: string
              serviceAccount:
                type: string
              topicName:
                type: string
            required:
            - triggerName
            - workflowPath
            - location
            - serviceAccount
            - topicName
    served: true
    storage: true

---
# Eventarc Trigger CR
apiVersion: idp.mycompany.com/v1
kind: CREventarcTrigger
metadata:
  name: my-eventarc-trigger
  namespace: config-control
spec:
  triggerName: my-trigger
  workflowPath: projects/test-gcp-tse/locations/us-central1/workflows/workflow-1
  location: us-central1
  serviceAccount: eventarctrigger-iam-gsa
  topicName: example-topic-1
---
# Storage Notification
apiVersion: storage.cnrm.cloud.google.com/v1beta1
kind: StorageNotification
metadata:
  name: storagenotification-finalize
  namespace: config-control
spec:
  bucketRef:
    name: crd-bucket
  payloadFormat: JSON_API_V1
  topicRef:
    name: example-topic-1
  eventTypes:
    - "OBJECT_FINALIZE"